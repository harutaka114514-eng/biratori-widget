<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>biratori-widget-fixed</title>
<style>
/* æ—¢å­˜ã®ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
body {
  font-family: "Segoe UI", "Hiragino Sans", "Noto Sans JP", sans-serif;
  background-color: #f0f0f0;
  background-position: center; background-size: cover; background-attachment: fixed; background-repeat: no-repeat;
  transition: background-image 0.5s ease-in-out;
  padding: 15px; color: #333; margin: 0;
}
body::before {
  content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(255, 255, 255, 0.4); z-index: -1;
}

h1 { margin: 5px 0 10px; font-size: 20px; font-weight: 600; text-align: center; text-shadow: 1px 1px 2px white; }
.widgets { display: flex; flex-direction: column; gap: 15px; max-width: 1200px; margin: 0 auto; }
.widget { background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 18px; box-shadow: 0 10px 25px rgba(0,0,0,.1); display: flex; flex-direction: column; box-sizing: border-box; }

.top-row { display: grid; grid-template-columns: 1fr 200px; gap: 12px; align-items: stretch; }
.info-bar { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
#clock { font-size: 22px; font-weight: 700; font-family: monospace; white-space: nowrap; }
.extra-info { display: flex; gap: 15px; flex-grow: 1; justify-content: center; border-left: 1px solid #ddd; border-right: 1px solid #ddd; padding: 0 15px; margin: 0 5px; overflow: hidden; }
.info-item { text-align: center; min-width: 0; flex: 1; display: flex; flex-direction: column; justify-content: center; }
.info-item .label { font-size: 10px; color: #888; display: block; margin-bottom: 3px; font-weight: bold; }
.info-item .content { font-size: 15px; font-weight: 700; color: #222; line-height: 1.3; }

.weekly-weather { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
.weather-day { text-align: center; font-size: 10px; }
.temp-max { color: #ef4444; font-weight: bold; }
.temp-min { color: #3b82f6; font-weight: bold; }

.garbage-button { background: #fef3c7; border-radius: 12px; padding: 10px; font-size: 13px; border: 1px solid #f59e0b; text-align: center; display: flex; flex-direction: column; justify-content: center; cursor: pointer; font-weight: bold; text-decoration: none; color: #92400e; min-height: 70px; }

/* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹æˆ */
.main-layout { display: grid; grid-template-columns: 1fr 350px; gap: 15px; }
.video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; background: #000; }
.video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
.video-tabs { display: flex; gap: 10px; margin-bottom: 10px; }
.video-tabs button { flex: 1; padding: 8px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; font-size: 12px; background: #eee; color: #666; }
.video-tabs button.active { background: #ff0000; color: #fff; }

/* ä¸‹æ®µï¼šãƒªãƒ³ã‚¯ã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
.bottom-widgets { display: grid; grid-template-columns: 220px 1fr; gap: 12px; margin-top: 15px; }

.link-box { display: flex; flex-direction: column; gap: 8px; justify-content: center; height: 100%; }
.link-box a { position: relative; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 10px; border-radius: 12px; text-decoration: none; font-weight: bold; font-size: 13px; transition: transform 0.1s; border: 1px solid rgba(0,0,0,0.1); }
.link-box a:active { transform: scale(0.98); }
.btn-domingo { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
.btn-sitakke { background-color: #fffbeb; color: #92400e; border-color: #fef3c7; }
.btn-gmail { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
.btn-deepl { background-color: #0f2d37; color: #ffffff; border-color: #000; }
.btn-okuyami { background-color: #f1f5f9; color: #334155; border-color: #cbd5e1; }

/* ãƒ‹ãƒ¥ãƒ¼ã‚¹ ã‚¹ã‚¿ã‚¤ãƒ« */
.news-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 5px; }
.news-tabs { display: flex; gap: 4px; flex-wrap: wrap; }
.news-tabs button { padding: 4px 8px; font-size: 10px; background: #e5e7eb; border: 0; border-radius: 999px; cursor: pointer; }
.news-tabs button.active { background: #2563eb; color: #fff; }

.read-all-btn { padding: 4px 8px; font-size: 9px; background: #fff; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; color: #666; white-space: nowrap; }
.read-all-btn:hover { background: #f0f0f0; }

.news-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px; }
.news-list li { background: #fff; border-radius: 8px; padding: 10px; border: 1px solid #eee; display: flex; align-items: flex-start; gap: 8px; transition: background 0.2s; }

/* ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå¤ªã•ã‚’çµ±ä¸€ã€æ—¢èª­ã‚’ç´«è‰²ã«ï¼‰ */
.news-list a { text-decoration: none; color: #2563eb; font-size: 12px; font-weight: 700; line-height: 1.4; flex: 1; }
.news-list li.is-read { background: #fdfdfd; }
.news-list li.is-read a { color: #800080 !important; } /* æŒ‡å®šã®æ—¢èª­ã‚«ãƒ©ãƒ¼ï¼ˆç´«ï¼‰ */

.unread-dot { width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; margin-top: 5px; flex-shrink: 0; }
.is-read .unread-dot { display: none; }

/* ãŠãã‚„ã¿ç­‰ã®æ–°ç€é€šçŸ¥ãƒãƒƒã‚¸ */
.badge { position: absolute; top: -5px; right: -5px; width: 12px; height: 12px; background: #ef4444; border-radius: 50%; border: 2px solid white; display: none; }
.badge.show { display: block; animation: pulse 2s infinite; }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
.cal-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.cal-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: #2563eb; font-weight: bold; }
.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
.cal-header { font-size: 12px; font-weight: bold; text-align: center; color: #666; padding-bottom: 5px; }
.cal-cell { background: #f8fafc; border-radius: 8px; padding: 5px; min-height: 55px; text-align: left; font-size: 12px; display: flex; flex-direction: column; border: 1px solid #edf2f7; }
.cal-num { font-weight: 700; margin-bottom: 2px; }
.sun { color: #ef4444; }
.sat { color: #3b82f6; }
.cal-today { outline: 3px solid #2563eb; background: #eff6ff; z-index: 1; }
.cal-dim { opacity: 0.3; }
.holiday-name { font-size: 9px; color: #ef4444; line-height: 1.1; margin-top: auto; }

@media(max-width:900px){ .main-layout { grid-template-columns: 1fr; } .bottom-widgets { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<h1>biratori-widget</h1>

<div class="widgets">
  <div class="top-row">
    <div class="widget">
      <div class="info-bar">
        <div id="clock">--:--:--</div>
        <div class="extra-info">
          <div class="info-item"><span class="label">ä»Šæ—¥ã®é‹å‹¢</span><div id="fortune" class="content">...</div></div>
          <div class="info-item"><span class="label">å¹³å–ã‚¢ã‚¤ãƒŒèª</span><div id="ainu" class="content">...</div></div>
        </div>
        <div style="text-align:right;">
            <a href="https://tenki.jp/forecast/1/4/2200/1602/10days.html" target="_blank" style="font-size:12px; color:#666; font-weight:bold; background:#eee; padding:2px 6px; border-radius:4px; text-decoration:none;">å¹³å–</a>
            <div id="weather" style="font-size:20px; font-weight:700; cursor:pointer;" onclick="window.open('https://tenki.jp/forecast/1/4/2200/1602/10days.html', '_blank')">--â„ƒ</div>
        </div>
      </div>
      <div id="weekly-weather" class="weekly-weather"></div>
    </div>
    <a href="https://biratorieisei-hokkaido.jp/biratorieisei/wp-content/uploads/r7biratori.pdf" target="_blank" class="garbage-button">
      ğŸ—‘ R7å¹´åº¦ã”ã¿åé›†PDF<span>ğŸ”¥æœˆæœ¨ / â™»æ°´</span>
    </a>
  </div>

  <div class="main-layout">
    <div class="left-content">
      <div class="widget">
        <div class="video-tabs">
          <button id="btn-v1" class="active" onclick="switchVideo('tvgbZZYS4Nk', 'btn-v1')">HTB</button>
          <button id="btn-v3" onclick="switchVideo('hA46WfBYdgo', 'btn-v3')">STV</button>
          <button id="btn-v2" onclick="switchVideo('c6Gqe6L_xZg', 'btn-v2')">ãƒ©ã‚¤ãƒ–ã‚«ãƒ¡ãƒ©</button>
        </div>
        <div class="video-container">
          <iframe id="main-video" src="https://www.youtube.com/embed/tvgbZZYS4Nk?autoplay=1&mute=1&enablejsapi=1" frameborder="0" allowfullscreen></iframe>
        </div>
      </div>

      <div class="bottom-widgets">
        <div class="widget">
          <div class="link-box">
            <a href="https://domingo.ne.jp/" target="_blank" class="link-btn btn-domingo">ğŸ“° Domingo</a>
            <a href="https://sitakke.jp/" target="_blank" class="link-btn btn-sitakke">ğŸ„ Sitakke</a>
            <a href="https://zenkoku-okuyami.com/obituary/hokkaido/biratoricho/" target="_blank" class="link-btn btn-okuyami" id="okuyami-btn" onclick="markOkuyamiRead()">
                ğŸ™ å¹³å–ç”ºãŠãã‚„ã¿ <span id="okuyami-badge" class="badge"></span>
            </a>
            <a href="https://mail.google.com/mail/u/0/#unread" target="_blank" class="link-btn btn-gmail">âœ‰ Gãƒ¡ãƒ¼ãƒ«</a>
            <a href="https://www.deepl.com/translator" target="_blank" class="link-btn btn-deepl">ğŸŒ DeepL ç¿»è¨³</a>
          </div>
        </div>
        <div class="widget">
          <div class="cal-nav">
            <button class="cal-btn" onclick="changeMonth(-1)">â—€</button>
            <div id="calTitle" style="font-weight:bold; font-size:16px;"></div>
            <button class="cal-btn" onclick="changeMonth(1)">â–¶</button>
          </div>
          <div id="calGrid" class="cal-grid"></div>
        </div>
      </div>
    </div>

    <div class="widget">
      <div class="news-header">
        <div class="news-tabs">
          <button data-type="nhk" class="active">NHK</button>
          <button data-type="doshin">é“æ–°</button>
          <button data-type="sakei">åœ°åŸŸ/é£Ÿ</button>
          <button data-type="nl">é“NL</button>
          <button data-type="v4jp">VALO</button>
        </div>
        <button class="read-all-btn" onclick="markCurrentTabAllRead()">ã™ã¹ã¦æ—¢èª­</button>
      </div>
      <ul id="news" class="news-list"></ul>
    </div>
  </div>
</div>

<script>
const urls = { 
  nhk: ["https://www.nhk.or.jp/rss/news/cat0.xml", "https://news.web.nhk/n-data/conf/na/rss/cat6.xml"],
  doshin: "https://www.hokkaido-np.co.jp/output/7/free/index.ad.xml", 
  sakei: [
    "https://sapporo.keizai.biz/rss.xml",
    "https://tomakomai.goguynet.jp/feed/",
    "https://meshitabi-hokkaido.com/feed/",
    "https://hre-net.com/feed/"
  ],
  nl: "https://hokkaido-nl.jp/index.xml", 
  v4jp: "https://valorantnews.jp/feed" 
};

let newsCache = { nhk: [], doshin: [], sakei: [], nl: [], v4jp: [] };
let readNewsLinks = new Set(JSON.parse(localStorage.getItem('read_news_links') || '[]'));

function setRandomBackground() {
  const images = ['https://images.unsplash.com/photo-1441974231531-c6227db76b6e','https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05','https://images.unsplash.com/photo-1501785888041-af3ef285b470','https://images.unsplash.com/photo-1464822759023-fed622ff2c3b','https://images.unsplash.com/photo-1506744038136-46273834b3fb'];
  document.body.style.backgroundImage = `url('${images[Math.floor(Math.random()*images.length)]}?auto=format&fit=crop&w=1600&q=80')`;
}
setRandomBackground();

async function preloadAllNews() {
  const rss2json = "https://api.rss2json.com/v1/api.json?rss_url=";
  const fetchPromises = Object.keys(urls).map(async (key) => {
    try {
      let items = [];
      const targetUrls = Array.isArray(urls[key]) ? urls[key] : [urls[key]];
      for (const url of targetUrls) {
        const r = await fetch(rss2json + encodeURIComponent(url));
        const d = await r.json();
        if (d.status === 'ok') items = items.concat(d.items);
      }
      const seen = new Set();
      newsCache[key] = items.filter(item => !seen.has(item.link) && seen.add(item.link))
                            .sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
      const activeTab = document.querySelector(".news-tabs button.active");
      if (activeTab && activeTab.dataset.type === key) renderNews(key);
    } catch(e) {}
  });
  await Promise.all(fetchPromises);
}

function renderNews(type) {
  const ul = document.getElementById("news");
  const items = newsCache[type] || [];
  if (items.length === 0) { ul.innerHTML = "<li>ãƒ­ãƒ¼ãƒ‰ä¸­...</li>"; return; }
  ul.innerHTML = items.slice(0, 15).map(i => {
    const isRead = readNewsLinks.has(i.link) ? 'is-read' : '';
    return `<li class="${isRead}">
      <span class="unread-dot"></span>
      <a href="${i.link}" target="_blank" onclick="markAsRead('${i.link}', this)">${i.title}</a>
    </li>`;
  }).join('');
}

function markAsRead(link, element) {
  readNewsLinks.add(link);
  localStorage.setItem('read_news_links', JSON.stringify(Array.from(readNewsLinks)));
  if(element) element.closest('li').classList.add('is-read');
}

function markCurrentTabAllRead() {
  const activeTab = document.querySelector(".news-tabs button.active");
  if (!activeTab) return;
  const type = activeTab.dataset.type;
  const items = newsCache[type] || [];
  items.forEach(i => readNewsLinks.add(i.link));
  localStorage.setItem('read_news_links', JSON.stringify(Array.from(readNewsLinks)));
  renderNews(type);
}

async function loadWeather() {
  try {
    const r = await fetch("https://api.open-meteo.com/v1/forecast?latitude=42.58&longitude=142.13&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo");
    const d = await r.json();
    const icons = {0:"â˜€ï¸",1:"ğŸŒ¤ï¸",2:"â›…",3:"â˜ï¸",45:"ğŸŒ«ï¸",61:"ğŸŒ§ï¸",71:"â„ï¸",95:"â›ˆï¸"};
    document.getElementById("weather").textContent = `${icons[d.current_weather.weathercode]||"â˜ï¸"} ${Math.round(d.current_weather.temperature)}â„ƒ`;
    let wHtml = "";
    for(let i=0; i<7; i++){
        const dt = new Date(d.daily.time[i]);
        wHtml += `<div class="weather-day"><div>${dt.getMonth()+1}/${dt.getDate()}</div><div style="font-size:14px;">${icons[d.daily.weathercode[i]]||"â˜ï¸"}</div><div><span class="temp-max">${Math.round(d.daily.temperature_2m_max[i])}</span>/<span class="temp-min">${Math.round(d.daily.temperature_2m_min[i])}</span></div></div>`;
    }
    document.getElementById("weekly-weather").innerHTML = wHtml;
  } catch(e){}
}

async function checkOkuyami() {
  try {
    const targetUrl = "https://zenkoku-okuyami.com/obituary/hokkaido/biratoricho/";
    const r = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`);
    const d = await r.json();
    const parser = new DOMParser();
    const doc = parser.parseFromString(d.contents, 'text/html');
    const updatedText = doc.body.innerText.match(/\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}/);
    if (updatedText) {
      const latestUpdate = updatedText[0];
      const lastRead = localStorage.getItem('okuyami_last_update');
      if (lastRead !== latestUpdate) {
        document.getElementById('okuyami-badge').classList.add('show');
        localStorage.setItem('okuyami_temp_latest', latestUpdate);
      }
    }
  } catch(e) {}
}

function markOkuyamiRead() {
  const latest = localStorage.getItem('okuyami_temp_latest');
  if (latest) {
    localStorage.setItem('okuyami_last_update', latest);
    document.getElementById('okuyami-badge').classList.remove('show');
  }
}

const ainuWords = [ ["ã‚¤ãƒ©ãƒ³ã‚«ãƒ©ã‡·ã‚šãƒ†", "ã“ã‚“ã«ã¡ã¯"], ["ã‚¤ãƒ¤ãƒ©ã‚¤ã‚±ãƒ¬", "ã‚ã‚ŠãŒã¨ã†"], ["ã‚¹ã‚¤ ã‚¦ãƒŒã‚«ãƒ©ãƒ³ ãƒ­", "ã¾ãŸä¼šã„ã¾ã—ã‚‡ã†"], ["ãƒ’ãƒ³ãƒŠ", "ç¾å‘³ã—ã„"], ["ãƒ”ãƒªã‚«", "è‰¯ã„"], ["ã‚«ãƒ ã‚¤", "ç¥"], ["ã‚³ã‚¿ãƒ³", "æ‘"], ["ã‚¤ã‚¿ã‡°", "è¨€è‘‰"], ["ãƒã‚»", "å®¶"], ["ã‚¢ãƒš", "ç«"], ["ãƒ¯ãƒƒã‚«", "æ°´"], ["ãƒ¬ãƒ©", "é¢¨"], ["ãƒãƒã‚¦", "æ˜Ÿ"], ["ãƒãƒ¥ã‡·ã‚š", "å¤ªé™½"], ["ã‚·ãƒª", "å¤§åœ°"] ];

let currentViewDate = new Date();
const HOLIDAYS_2026 = {"2026-01-01":"å…ƒæ—¥","2026-01-12":"æˆäººã®æ—¥","2026-02-11":"å»ºå›½è¨˜å¿µã®æ—¥","2026-02-23":"å¤©çš‡èª•ç”Ÿæ—¥","2026-03-20":"æ˜¥åˆ†ã®æ—¥","2026-04-29":"æ˜­å’Œã®æ—¥","2026-05-03":"æ†²æ³•è¨˜å¿µæ—¥","2026-05-04":"ã¿ã©ã‚Šã®æ—¥","2026-05-05":"ã“ã©ã‚‚ã®æ—¥","2026-05-06":"æŒ¯æ›¿ä¼‘æ—¥","2026-07-20":"æµ·ã®æ—¥","2026-08-11":"å±±ã®æ—¥","2026-09-21":"æ•¬è€ã®æ—¥","2026-09-22":"å›½æ°‘ã®ä¼‘æ—¥","2026-09-23":"ç§‹åˆ†ã®æ—¥","2026-10-12":"ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥","2026-11-03":"æ–‡åŒ–ã®æ—¥","2026-11-23":"å‹¤åŠ´æ„Ÿè¬ã®æ—¥"};
function changeMonth(diff) { currentViewDate.setMonth(currentViewDate.getMonth() + diff); drawCal(); }
function drawCal(){
  const year=currentViewDate.getFullYear(), month=currentViewDate.getMonth(), today = new Date();
  document.getElementById("calTitle").textContent=`${year}å¹´ ${month+1}æœˆ`;
  let html = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].map(h => `<div class=\"cal-header\">${h}</div>`).join('');
  const start=new Date(year, month, 1); start.setDate(1 - start.getDay());
  for(let i=0; i<42; i++){
    const d=new Date(start); d.setDate(start.getDate()+i);
    const dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const hName = (d.getFullYear() === 2026) ? HOLIDAYS_2026[dateStr] : "";
    let colorClass = (d.getDay() === 0 || hName) ? "sun" : (d.getDay() === 6 ? "sat" : "");
    const isToday = d.toDateString() === today.toDateString() ? "cal-today" : "";
    const isOtherMonth = d.getMonth() !== month ? "cal-dim" : "";
    html += `<div class=\"cal-cell ${isOtherMonth} ${isToday}\"><div class=\"cal-num ${colorClass}\">${d.getDate()}</div>${hName ? `<div class=\"holiday-name\">${hName}</div>` : ""}</div>`;
  }
  document.getElementById("calGrid").innerHTML=html;
}

function clock(){
  const n=new Date(); const m=n.getMonth()+1, d=n.getDate(), w=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][n.getDay()];
  const h=String(n.getHours()).padStart(2,"0"), i=String(n.getMinutes()).padStart(2,"0"), s=String(n.getSeconds()).padStart(2,"0");
  document.getElementById("clock").innerHTML=`<span style=\"font-size:14px\">${m}/${d}(${w})</span> ${h}:${i}:${s}`;
}

function switchVideo(id, btnId) {
  document.getElementById('main-video').src = `https://www.youtube.com/embed/${id}?autoplay=1&mute=1&enablejsapi=1`;
  document.querySelectorAll('.video-tabs button').forEach(b => b.classList.remove('active'));
  document.getElementById(btnId).classList.add('active');
}

setInterval(clock, 1000); clock();
const aw = ainuWords[Math.floor(Math.random()*ainuWords.length)];
document.getElementById("ainu").innerHTML = `${aw[0]}<span>(${aw[1]})</span>`;
document.getElementById("fortune").textContent = ["å¹³å–å‰ ğŸ…", "å¤§å‰ ğŸŒŸ", "ä¸­å‰ âœ¨", "å°å‰ ğŸ€", "æœ«å‰ ğŸ"][Math.floor(Math.random()*5)];
loadWeather(); drawCal(); checkOkuyami(); preloadAllNews();

document.querySelectorAll(".news-tabs button").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".news-tabs button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active"); renderNews(b.dataset.type);
  };
});
</script>
</body>
</html>