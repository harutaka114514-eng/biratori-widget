<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>biratori-widget</title>

<style>
body{
  font-family:"Segoe UI","Hiragino Sans","Noto Sans JP",sans-serif;
  background:
    linear-gradient(rgba(255,255,255,.75),rgba(255,255,255,.75)),
    url("background.jpg") center/cover no-repeat fixed;
  padding:40px;
  color:#333;
}
h1{margin:0 0 30px;font-size:26px;font-weight:600}

.widgets{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:24px;
}
.widget{
  background:rgba(255,255,255,.9);
  padding:20px;
  border-radius:18px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
.widget h2{margin:0 0 12px;font-size:16px}

/* ä»Šæ—¥ */
.today{display:flex;justify-content:space-between;gap:16px}
#clock{font-size:18px;line-height:1.6}
.weather{text-align:right}
.weather-icon{font-size:30px}
.temp{font-size:22px;font-weight:600}
.muted{color:#666;font-size:13px}

/* ãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼ˆé«˜ã•å›ºå®šï¼‰ */
.news-tabs{display:flex;gap:6px;margin-bottom:8px}
.news-tabs button{
  border:0;border-radius:999px;
  padding:5px 10px;font-size:12px;
  background:#e5e7eb;cursor:pointer;
}
.news-tabs button.active{background:#2563eb;color:#fff}
.news-list{
  list-style:none;padding:0;margin:0;
  min-height:140px;
}
.news-list li{
  background:#f8fafc;
  border-radius:12px;
  padding:10px 12px;
  margin-top:8px;
}
.news-list li:first-child{margin-top:0}
.news-list a{
  text-decoration:none;color:#333;
  font-size:14px;line-height:1.45;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}
.news-more{text-align:right;margin-top:8px}
.news-more a{font-size:13px;color:#2563eb;text-decoration:none}

/* ã‚´ãƒŸ */
.garbage-list li{
  background:#f8fafc;
  border-radius:10px;
  padding:8px 10px;
  margin-top:6px;
}

/* ãƒªãƒ³ã‚¯ */
.links a{
  display:block;padding:10px 14px;
  border-radius:10px;
  background:#f3f4f6;
  text-decoration:none;color:#333;
}

/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
.calendar{grid-column:1/-1}
.cal-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.cal-btn{border:0;border-radius:8px;padding:4px 8px;background:#f3f4f6;cursor:pointer}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cal-dow div{text-align:center;font-size:11px;color:#666}
.cal-cell{background:#f8fafc;border-radius:10px;padding:6px;min-height:56px}
.cal-num{font-weight:700;font-size:13px}
.cal-dim{opacity:.35}
.cal-today{outline:2px solid #93c5fd;background:#eef2ff}
.sun{color:#b91c1c}
.sat{color:#1d4ed8}
.holiday{font-size:10px;color:#b91c1c;margin-top:2px}

/* ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¿ãƒ–ï¼šæ”¹è¡Œé˜²æ­¢ */
.news-tabs{
  flex-wrap: nowrap;
}
.news-tabs button{
  white-space: nowrap;
}

/* ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¿ãƒ–ï¼š4åˆ—ã‚°ãƒªãƒƒãƒ‰ã§å´©ã‚Œãªã„ */
.news-tabs{
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:6px;
}
.news-tabs button{
  width:100%;
  padding:5px 6px;     /* ã¡ã‚‡ã„è©°ã‚ */
  font-size:11px;      /* ã¡ã‚‡ã„å°ã•ã */
  white-space:nowrap;  /* æ–‡å­—æŠ˜ã‚Šè¿”ã•ãªã„ */
}


</style>
</head>

<body>
<h1>biratori-widget</h1>

<div class="widgets">

<!-- ä»Šæ—¥ -->
<div class="widget">
<h2>ğŸ“… ä»Šæ—¥ï¼ˆå¹³å–ï¼‰</h2>
<div class="today">
  <div id="clock">--</div>
  <div class="weather">
    <div class="weather-icon" id="weatherIcon">--</div>
    <div class="temp" id="temp">--â„ƒ</div>
    <div id="weatherText" class="muted"></div>
  </div>
</div>
</div>

<!-- ãƒ‹ãƒ¥ãƒ¼ã‚¹ -->
<div class="widget">
<h2>ğŸ“° ãƒ‹ãƒ¥ãƒ¼ã‚¹</h2>
<div class="news-tabs">
  <button data-type="nhk" class="active">NHK</button>
  <button data-type="hidaka">æ—¥é«˜å ±çŸ¥</button>
  <button data-type="tomakomai">è‹«å°ç‰§</button>
  <button data-type="doshin">é“æ–°</button>
</div>
<ul id="news" class="news-list"><li class="muted">èª­ã¿è¾¼ã¿ä¸­â€¦</li></ul>
<div class="news-more">
  <a id="newsMore" href="https://www.nhk.or.jp/news/" target="_blank">ã‚‚ã£ã¨è¦‹ã‚‹</a>
</div>
</div>

<!-- ã‚´ãƒŸæ¨ã¦ -->
<div class="widget">
<h2>ğŸ—‘ ã‚´ãƒŸæ¨ã¦ï¼ˆå¹³å–ï¼‰</h2>
<ul class="garbage-list">
  <li>ç‡ƒãˆã‚‹ã‚´ãƒŸã€€æœˆãƒ»æœ¨</li>
  <li>è³‡æºã”ã¿ã€€æ°´<br>ç¥æ—¥ã‚’é™¤ã</li>
</ul>

<div class="news-more">
  <a href="https://biratorieisei-hokkaido.jp/biratorieisei/wp-content/uploads/r7biratori.pdf"
     target="_blank">ğŸ“„ ã‚´ãƒŸåé›†ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼PDF</a>
</div>
</div>

<!-- ãƒªãƒ³ã‚¯ -->
<div class="widget">
<h2>ğŸ”— ãƒªãƒ³ã‚¯é›†</h2>
<ul class="links">
<li><a href="https://www.youtube.com/?app=desktop&hl=ja/" target="_blank">youtube</a></li>
<li><a href="https://www.twitch.tv" target="_blank">Twitch</a></li>
<li><a href="https://www.amazon.co.jp/" target="_blank">amazon</a></li>
<li><a href="https://x.com" target="_blank">X</a></li>
<li><a href="https://www.instagram.com/" target="_blank">instagram</a></li>
<li><a href="https://mail.google.com/" target="_blank">Gmail</a></li>
</ul>
</div>

<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
<div class="widget calendar">
<h2>ğŸ—“ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
<div class="cal-top">
  <div id="calTitle"></div>
  <div>
    <button class="cal-btn" id="prev">â—€</button>
    <button class="cal-btn" id="todayBtn">ä»Šæ—¥</button>
    <button class="cal-btn" id="next">â–¶</button>
  </div>
</div>
<div class="cal-grid cal-dow" id="calDow"></div>
<div class="cal-grid" id="calGrid"></div>
</div>

</div>

<script>
/* æ™‚è¨ˆ */
const clockEl=document.getElementById("clock");
function clock(){
  const n=new Date();
  clockEl.innerHTML=
    `${n.getFullYear()}å¹´${n.getMonth()+1}æœˆ${n.getDate()}æ—¥<br>
     ${String(n.getHours()).padStart(2,"0")}æ™‚${String(n.getMinutes()).padStart(2,"0")}åˆ†`;
}
clock();setInterval(clock,60000);

/* å¤©æ°—ï¼ˆå®Œå…¨ã‚¢ã‚¤ã‚³ãƒ³å¯¾å¿œï¼‰ */
const weatherIcons={
  0:"â˜€ï¸",1:"ğŸŒ¤ï¸",2:"â›…",3:"â˜ï¸",45:"ğŸŒ«ï¸",48:"ğŸŒ«ï¸",
  51:"ğŸŒ¦ï¸",53:"ğŸŒ¦ï¸",55:"ğŸŒ¦ï¸",61:"ğŸŒ§ï¸",63:"ğŸŒ§ï¸",65:"ğŸŒ§ï¸",
  71:"â„ï¸",73:"â„ï¸",75:"â„ï¸",77:"â„ï¸",
  80:"ğŸŒ§ï¸",81:"ğŸŒ§ï¸",82:"ğŸŒ§ï¸",95:"â›ˆï¸"
};
(async()=>{
  const r=await fetch("https://api.open-meteo.com/v1/forecast?latitude=42.58&longitude=142.13&current_weather=true");
  const w=(await r.json()).current_weather;
  document.getElementById("temp").textContent=w.temperature+"â„ƒ";
  document.getElementById("weatherIcon").textContent=weatherIcons[w.weathercode]||"ğŸŒ¡ï¸";
  document.getElementById("weatherText").textContent="é¢¨ "+w.windspeed+"m/s";
})();

/* ãƒ‹ãƒ¥ãƒ¼ã‚¹ */
async function rss(url){
  const r = await fetch("https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(url));
  return (await r.json()).items || [];
}

function setNews(items){
  const ul = document.getElementById("news");
  ul.innerHTML = "";
  items.slice(0, 3).forEach(i=>{
    ul.innerHTML += `<li><a href="${i.link}" target="_blank">${i.title}</a></li>`;
  });
}

// â˜…ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®â€œä¸Šæ›¸ãé˜²æ­¢â€
let newsReqId = 0;

// â˜…æ—¥é«˜å ±çŸ¥ï¼ˆhokkaido-nl.jp/member/6ï¼‰HTMLå–å¾—ï¼‹æˆåŠŸã‚­ãƒ£ãƒƒã‚·ãƒ¥
async function loadHidakaHochi(){
  const target = "https://hokkaido-nl.jp/member/6";
  const CACHE_KEY = "hidaka_hochi_cache_v3";
  const CACHE_MS  = 20 * 60 * 1000; // 20åˆ†

  // æˆåŠŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿
  try{
    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || "null");
    if(cached && cached.ts && (Date.now()-cached.ts) < CACHE_MS && Array.isArray(cached.items) && cached.items.length){
      return cached.items;
    }
  }catch(e){}

  async function fetchText(url, timeoutMs=9000){
    const ac = new AbortController();
    const t = setTimeout(()=>ac.abort(), timeoutMs);
    try{
      const r = await fetch(url, { cache:"no-store", signal: ac.signal });
      if(!r.ok) return "";
      return await r.text();
    }catch(e){
      return "";
    }finally{
      clearTimeout(t);
    }
  }

  const tryUrls = [
    "https://api.allorigins.win/raw?url=" + encodeURIComponent(target),
    "https://corsproxy.io/?" + encodeURIComponent(target),
    "https://r.jina.ai/https://hokkaido-nl.jp/member/6"
  ];

  let html = "";
  for(const u of tryUrls){
    html = await fetchText(u);
    if(html && html.length > 500) break;
  }
  if(!html) return [];

  // HTMLã¨ã—ã¦å–ã‚Œã¦ãªã„ãªã‚‰å¤±æ•—ï¼ˆå¤±æ•—ç‰ˆã‚’ä½œã‚‰ãªã„ï¼‰
  if(!html.includes("<a") || !html.toLowerCase().includes("</html>")) return [];

  const doc = new DOMParser().parseFromString(html, "text/html");
  const links = [
    ...doc.querySelectorAll("h3 a[href*='/article/']"),
    ...doc.querySelectorAll("a[href*='/article/']")
  ];

  const items = [];
  const seen = new Set();
  for(const a of links){
    let title = (a.textContent || "").trim().replace(/\s+/g," ");
    let link  = (a.getAttribute("href") || "").trim();
    if(!title || title.length < 8) continue;
    if(!link) continue;

    if(link.startsWith("/")) link = "https://hokkaido-nl.jp" + link;
    if(!/https?:\/\/hokkaido-nl\.jp\/article\/\d+/.test(link)) continue;

    if(seen.has(link)) continue;
    seen.add(link);

    items.push({ title: "ã€æ—¥é«˜å ±çŸ¥ã€‘" + title, link });
    if(items.length >= 10) break;
  }

  if(!items.length) return [];

  try{
    localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), items }));
  }catch(e){}

  return items;
}

// â˜…é“æ–°ï¼ˆåŒ—æµ·é“æ–°èï¼šè‹«å°ç‰§ãƒ»æ—¥é«˜åœï¼‰HTMLå–å¾—ï¼‹æˆåŠŸã‚­ãƒ£ãƒƒã‚·ãƒ¥
async function loadDoshin(){
  const target = "https://www.hokkaido-np.co.jp/hokkaido/area_tomakomai/";
  const CACHE_KEY = "doshin_cache_tomakomai_v1";
  const CACHE_MS  = 20 * 60 * 1000; // 20åˆ†

  try{
    const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || "null");
    if(cached && cached.ts && (Date.now()-cached.ts) < CACHE_MS && Array.isArray(cached.items) && cached.items.length){
      return cached.items;
    }
  }catch(e){}

  async function fetchText(url, timeoutMs=9000){
    const ac = new AbortController();
    const t = setTimeout(()=>ac.abort(), timeoutMs);
    try{
      const r = await fetch(url, { cache:"no-store", signal: ac.signal });
      if(!r.ok) return "";
      return await r.text();
    }catch(e){
      return "";
    }finally{
      clearTimeout(t);
    }
  }

  const tryUrls = [
    "https://api.allorigins.win/raw?url=" + encodeURIComponent(target),
    "https://corsproxy.io/?" + encodeURIComponent(target)
  ];

  let html = "";
  for(const u of tryUrls){
    html = await fetchText(u);
    if(html && html.length > 500) break;
  }
  if(!html) return [];

  if(!html.includes("<a") || !html.toLowerCase().includes("</html>")) return [];

  const doc = new DOMParser().parseFromString(html, "text/html");
  const links = Array.from(doc.querySelectorAll("a[href]"));

  const items = [];
  const seen = new Set();

  for(const a of links){
    let title = (a.textContent || "").trim().replace(/\s+/g," ");
    let href  = (a.getAttribute("href") || "").trim();
    if(!title || title.length < 10) continue;
    if(!href) continue;

    // è¨˜äº‹ãƒªãƒ³ã‚¯ã£ã½ã„ã‚‚ã®ã ã‘
    if(!(href.includes("/article/") || href.includes("/news/"))) continue;

    // ç›¸å¯¾â†’çµ¶å¯¾
    if(href.startsWith("/")) href = "https://www.hokkaido-np.co.jp" + href;

    // ãƒ‰ãƒ¡ã‚¤ãƒ³ç¸›ã‚Š
    if(!href.startsWith("https://www.hokkaido-np.co.jp/")) continue;

    if(seen.has(href)) continue;
    seen.add(href);

    items.push({ title: "ã€é“æ–°ã€‘" + title, link: href });
    if(items.length >= 10) break;
  }

  if(!items.length) return [];

  try{
    localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), items }));
  }catch(e){}

  return items;
}

const NEWS = {
  nhk:      { mode:"rss",    rss:"https://www.nhk.or.jp/rss/news/cat0.xml", more:"https://www.nhk.or.jp/news/" },
  hidaka:   { mode:"hochi",  more:"https://hokkaido-nl.jp/member/6" },
  tomakomai:{ mode:"rss",    rss:"https://tomakomai.goguynet.jp/feed/",     more:"https://tomakomai.goguynet.jp/" },
  doshin:   { mode:"doshin", more:"https://www.hokkaido-np.co.jp/hokkaido/area_tomakomai/" }
};

async function loadNews(type){
  const myId = ++newsReqId;

  try{
    const ul = document.getElementById("news");
    ul.innerHTML = `<li class="muted">èª­ã¿è¾¼ã¿ä¸­â€¦</li>`;

    if(NEWS[type]?.mode === "hochi"){
      const items = await loadHidakaHochi();
      if(myId !== newsReqId) return;
      if(!items.length){
        ul.innerHTML = `<li class="muted">å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆæ—¥é«˜å ±çŸ¥ï¼‰</li>`;
      }else{
        setNews(items);
      }
      newsMore.href = NEWS[type].more;
      return;
    }

    if(NEWS[type]?.mode === "doshin"){
      const items = await loadDoshin();
      if(myId !== newsReqId) return;
      if(!items.length){
        ul.innerHTML = `<li class="muted">å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆé“æ–°ï¼‰</li>`;
      }else{
        setNews(items);
      }
      newsMore.href = NEWS[type].more;
      return;
    }

    // RSSï¼ˆNHK/è‹«å°ç‰§ï¼‰
    const items = await rss(NEWS[type].rss);
    if(myId !== newsReqId) return;

    setNews(items);
    newsMore.href = NEWS[type].more;

  }catch(e){
    if(myId !== newsReqId) return;
    document.getElementById("news").innerHTML = `<li class="muted">ã‚¨ãƒ©ãƒ¼ï¼šå–å¾—ã§ãã¾ã›ã‚“</li>`;
    console.error(e);
  }
}

document.querySelectorAll(".news-tabs button").forEach(b=>{
  b.onclick = ()=>{
    document.querySelectorAll(".news-tabs button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    loadNews(b.dataset.type);
  };
});

loadNews("nhk");
// å…ˆèª­ã¿ï¼ˆä½“æ„Ÿé«˜é€ŸåŒ–ï¼‰
setTimeout(()=>{ loadHidakaHochi().catch(()=>{}); }, 1200);
setTimeout(()=>{ loadDoshin().catch(()=>{}); }, 1800);


/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆç¥æ—¥ãƒ•ãƒ«ï¼‰ */
const calDow = document.getElementById("calDow");
const calGrid = document.getElementById("calGrid");
const calTitle = document.getElementById("calTitle");
const prev = document.getElementById("prev");
const next = document.getElementById("next");
const todayBtn = document.getElementById("todayBtn");

const DOW=["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
calDow.innerHTML=DOW.map((d,i)=>`<div class="${i==0?"sun":i==6?"sat":""}">${d}</div>`).join("");

function nthMon(y,m,n){
  const f=new Date(y,m,1);
  return new Date(y,m,1+((8-f.getDay())%7)+(n-1)*7);
}
function ve(y){return Math.floor(20.8431+0.242194*(y-1980)-Math.floor((y-1980)/4))}
function ae(y){return Math.floor(23.2488+0.242194*(y-1980)-Math.floor((y-1980)/4))}
function holidays(y){
  const H=new Map();const add=(d,n)=>H.set(d.toDateString(),n);
  add(new Date(y,0,1),"å…ƒæ—¥");
  add(nthMon(y,0,2),"æˆäººã®æ—¥");
  add(new Date(y,1,11),"å»ºå›½è¨˜å¿µã®æ—¥");
  add(new Date(y,1,23),"å¤©çš‡èª•ç”Ÿæ—¥");
  add(new Date(y,2,ve(y)),"æ˜¥åˆ†ã®æ—¥");
  add(new Date(y,3,29),"æ˜­å’Œã®æ—¥");
  add(new Date(y,4,3),"æ†²æ³•è¨˜å¿µæ—¥");
  add(new Date(y,4,4),"ã¿ã©ã‚Šã®æ—¥");
  add(new Date(y,4,5),"ã“ã©ã‚‚ã®æ—¥");
  add(nthMon(y,6,3),"æµ·ã®æ—¥");
  add(new Date(y,7,11),"å±±ã®æ—¥");
  add(nthMon(y,8,3),"æ•¬è€ã®æ—¥");
  add(new Date(y,8,ae(y)),"ç§‹åˆ†ã®æ—¥");
  add(nthMon(y,9,2),"ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥");
  add(new Date(y,10,3),"æ–‡åŒ–ã®æ—¥");
  add(new Date(y,10,23),"å‹¤åŠ´æ„Ÿè¬ã®æ—¥");
  return H;
}
let view=new Date();view.setDate(1);
function draw(){
  calTitle.textContent=`${view.getFullYear()}å¹´ ${view.getMonth()+1}æœˆ`;
  calGrid.innerHTML="";
  const start=new Date(view);start.setDate(1-start.getDay());
  const today=new Date();
  const hol=holidays(view.getFullYear());
  for(let i=0;i<35;i++){
    const d=new Date(start);d.setDate(start.getDate()+i);
    calGrid.innerHTML+=`
    <div class="cal-cell ${d.getMonth()!=view.getMonth()?"cal-dim":""} ${d.toDateString()==today.toDateString()?"cal-today":""}">
      <div class="cal-num ${d.getDay()==0?"sun":d.getDay()==6?"sat":""}">${d.getDate()}</div>
      ${hol.has(d.toDateString())?`<div class="holiday">${hol.get(d.toDateString())}</div>`:""}
    </div>`;
  }
}
prev.onclick=()=>{view.setMonth(view.getMonth()-1);draw()};
next.onclick=()=>{view.setMonth(view.getMonth()+1);draw()};
todayBtn.onclick=()=>{const n=new Date();view=new Date(n.getFullYear(),n.getMonth(),1);draw()};
draw();
</script>
</body>
</html>
